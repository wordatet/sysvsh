#!/bin/sh
# Configure script for sysvsh - SVR4 Bourne Shell port
# POSIX-compliant, no autoconf required

set -e

# Defaults
PREFIX=/usr/local
CC="${CC:-}"
CFLAGS="${CFLAGS:-}"
LDFLAGS="${LDFLAGS:-}"
LIBS=""
HOST=""
BUILD=""

# Colors for output (if terminal supports it)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    NC=''
fi

msg() {
    printf "%b%s%b\n" "$GREEN" "$1" "$NC"
}

warn() {
    printf "%b%s%b\n" "$YELLOW" "$1" "$NC"
}

error() {
    printf "%b%s%b\n" "$RED" "$1" "$NC" >&2
    exit 1
}

usage() {
    cat <<EOF
Usage: ./configure [options]

Options:
  --prefix=DIR          Install prefix [/usr/local]
  --host=TRIPLET        Cross-compile target (e.g., aarch64-linux-gnu)
  --cc=COMPILER         C compiler to use [cc]
  --cflags=FLAGS        Additional CFLAGS
  --ldflags=FLAGS       Additional LDFLAGS
  --help                Show this help

Examples:
  ./configure
  ./configure --prefix=/opt/sysvsh
  ./configure --host=aarch64-linux-gnu --cc=aarch64-linux-gnu-gcc
EOF
    exit 0
}

# Parse arguments
while [ $# -gt 0 ]; do
    case "$1" in
        --prefix=*)   PREFIX="${1#*=}" ;;
        --host=*)     HOST="${1#*=}" ;;
        --cc=*)       CC="${1#*=}" ;;
        --cflags=*)   CFLAGS="${1#*=}" ;;
        --ldflags=*)  LDFLAGS="${1#*=}" ;;
        --help|-h)    usage ;;
        *)            warn "Unknown option: $1" ;;
    esac
    shift
done

# Cross-compile setup
if [ -n "$HOST" ]; then
    CC="${HOST}-gcc"
    msg "Cross-compiling for $HOST"
fi

msg "Configuring sysvsh..."

# Detect build system
BUILD_OS=$(uname -s)
BUILD_ARCH=$(uname -m)
msg "Build system: $BUILD_OS $BUILD_ARCH"

# Native Android detection for compiler selection
if [ -z "$CC" ]; then
    if [ "$BUILD_OS" = "Android" ] || [ -d /system ]; then
        if command -v gcc-13 >/dev/null 2>&1; then
            CC="gcc-13"
            msg "Android detected: prioritizing gcc-13"
        fi
    fi
fi
CC="${CC:-cc}"

# Test compiler
msg "Checking for C compiler... $CC"
cat > conftest.c <<EOF
int main(void) { return 0; }
EOF

if ! $CC -o conftest conftest.c 2>/dev/null; then
    error "C compiler '$CC' not found or not working"
fi
rm -f conftest conftest.c

# Detect target OS
if [ -n "$HOST" ]; then
    case "$HOST" in
        *-linux-android*) TARGET_OS="Android" ;;
        *-linux-*)    TARGET_OS="Linux" ;;
        *-freebsd*)   TARGET_OS="FreeBSD" ;;
        *-darwin*)    TARGET_OS="Darwin" ;;
        *-netbsd*)    TARGET_OS="NetBSD" ;;
        *-openbsd*)   TARGET_OS="OpenBSD" ;;
        *)            TARGET_OS="Unknown" ;;
    esac
else
    # Check for Android natively
    cat > conftest.c <<EOF
#ifdef __ANDROID__
int main(void) { return 0; }
#else
#error Not Android
#endif
EOF
    if $CC -c conftest.c -o conftest.o 2>/dev/null; then
        TARGET_OS="Android"
    else
        TARGET_OS="$BUILD_OS"
    fi
    rm -f conftest.c conftest.o
fi
msg "Target OS: $TARGET_OS"

# Base CFLAGS for K&R C compatibility
BASE_CFLAGS="-I. -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 -std=gnu89 -O2"
BASE_CFLAGS="$BASE_CFLAGS -Wno-implicit-int -Wno-implicit-function-declaration"
BASE_CFLAGS="$BASE_CFLAGS -Wno-return-type -Wno-incompatible-pointer-types"
BASE_CFLAGS="$BASE_CFLAGS -Wno-pointer-sign -Wno-unused-result"

# OS-specific settings
case "$TARGET_OS" in
    Linux)
        msg "Configuring for Linux..."
        LIBS=""
        ;;
    Android)
        msg "Configuring for Android/Termux..."
        BASE_CFLAGS="$BASE_CFLAGS -D_GNU_SOURCE"
        # Termux specific path adjustment
        if [ -n "$TERMUX_VERSION" ] || [ -d /data/data/com.termux ]; then
            msg "  Termux detected, setting prefixes..."
            PREFIX="${PREFIX:-/data/data/com.termux/files/usr}"
            SH_DEFPATH="/data/data/com.termux/files/usr/bin:/data/data/com.termux/files/usr/bin/applets:/system/bin"
            SH_SYSPROFILE="/data/data/com.termux/files/usr/etc/profile"
            SH_TMPPREFIX="/data/data/com.termux/files/usr/tmp/sh-"
        else
            # Generic Android (local/tmp or side-loaded)
            SH_DEFPATH="/system/bin:/system/xbin:/data/local/tmp"
            SH_SYSPROFILE="/system/etc/profile"
            SH_TMPPREFIX="/data/local/tmp/sh-"
        fi
        BASE_CFLAGS="$BASE_CFLAGS -DSH_DEFPATH='\"$SH_DEFPATH\"'"
        BASE_CFLAGS="$BASE_CFLAGS -DSH_SYSPROFILE='\"$SH_SYSPROFILE\"'"
        BASE_CFLAGS="$BASE_CFLAGS -DSH_TMPPREFIX='\"$SH_TMPPREFIX\"'"
        LIBS=""
        ;;
    FreeBSD|NetBSD|OpenBSD)
        msg "Configuring for $TARGET_OS..."
        LIBS=""
        ;;
    Darwin)
        msg "Configuring for macOS..."
        # macOS may need different flags
        BASE_CFLAGS="$BASE_CFLAGS -Wno-deprecated-declarations"
        ;;
    *)
        warn "Unknown OS, using generic settings"
        ;;
esac

# Check for required headers
msg "Checking headers..."

check_header() {
    header="$1"
    printf "  checking %s... " "$header"
    cat > conftest.c <<EOF
#include <$header>
int main(void) { return 0; }
EOF
    if $CC $BASE_CFLAGS -c conftest.c -o conftest.o 2>/dev/null; then
        echo "yes"
        rm -f conftest.c conftest.o
        return 0
    else
        echo "no"
        rm -f conftest.c conftest.o
        return 1
    fi
}

check_header "stdio.h" || error "Missing required header: stdio.h"
check_header "unistd.h" || error "Missing required header: unistd.h"
check_header "signal.h" || error "Missing required header: signal.h"
check_header "termios.h" || error "Missing required header: termios.h"
check_header "sys/types.h" || error "Missing required header: sys/types.h"
check_header "sys/wait.h" || error "Missing required header: sys/wait.h"
check_header "sys/stat.h" || error "Missing required header: sys/stat.h"
check_header "dirent.h" || error "Missing required header: dirent.h"
check_header "fcntl.h" || error "Missing required header: fcntl.h"
check_header "setjmp.h" || error "Missing required header: setjmp.h"

# Optional headers
if check_header "sys/resource.h"; then
    BASE_CFLAGS="$BASE_CFLAGS -DHAVE_SYS_RESOURCE_H"
fi

# Merge user CFLAGS
FINAL_CFLAGS="$BASE_CFLAGS $CFLAGS"

# Generate Makefile
msg "Generating Makefile..."

TAB=$(printf '\t')

cat > Makefile <<EOF
# Generated by configure - do not edit
# sysvsh - SVR4 Bourne Shell port

CC = $CC
CFLAGS = $FINAL_CFLAGS
LDFLAGS = $LDFLAGS
LIBS = $LIBS
PREFIX = $PREFIX

MAINS = sh
OBJECTS = args.o blok.o cmd.o ctype.o defs.o echo.o error.o expand.o \\
	fault.o func.o hash.o hashserv.o io.o macro.o main.o msg.o \\
	name.o print.o pwd.o service.o setbrk.o stak.o string.o test.o \\
	word.o xec.o bltin.o jobs.o ulimit.o compat.o

all: \$(MAINS)

sh: \$(OBJECTS)
${TAB}\$(CC) \$(CFLAGS) -o sh \$(OBJECTS) \$(LDFLAGS) \$(LIBS)

.c.o:
${TAB}\$(CC) \$(CFLAGS) -c $<

install: sh
${TAB}mkdir -p \$(DESTDIR)\$(PREFIX)/bin
${TAB}cp sh \$(DESTDIR)\$(PREFIX)/bin/sysvsh
${TAB}chmod 755 \$(DESTDIR)\$(PREFIX)/bin/sysvsh

uninstall:
${TAB}rm -f \$(DESTDIR)\$(PREFIX)/bin/sysvsh

clean:
${TAB}rm -f \$(OBJECTS) \$(MAINS)

distclean: clean
${TAB}rm -f Makefile config.log

test: all
${TAB}@echo "Running stability tests..."
${TAB}@if [ -x ./stress.sh ]; then ./stress.sh; fi

# Dependencies
\$(OBJECTS): defs.h mode.h name.h stak.h brkincr.h ctype.h

.PHONY: all clean distclean install uninstall test
EOF

# Summary
msg ""
msg "Configuration complete!"
msg ""
echo "  Prefix:    $PREFIX"
echo "  Compiler:  $CC"
echo "  CFLAGS:    $FINAL_CFLAGS"
echo "  LDFLAGS:   $LDFLAGS"
echo "  Target OS: $TARGET_OS"
msg ""
msg "Run 'make' to build, 'make install' to install."
